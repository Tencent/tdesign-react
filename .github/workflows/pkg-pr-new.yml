name: Publish_Any_Commit
on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

jobs:
  build:
    if: ${{ github.repository == 'Tencent/tdesign-react' && !startsWith(github.head_ref, 'release/')}}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        react: [react-18,react-19]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: pnpm/action-setup@v4 

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - if: matrix.react == 'react-19'
        run: node script/migrate/react19.js

      - if: matrix.react == 'react-19'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let pkg = JSON.parse(fs.readFileSync('./packages/tdesign-react/package.json', 'utf8'));
            pkg.name='tdesign-react-next';
            fs.writeFileSync('./packages/tdesign-react/package.json', JSON.stringify(pkg, null, 2));

      - run: pnpm install

      - run: pnpm run build

      - uses: actions/upload-artifact@v4
        with:
          name: ${{matrix.react}}
          path: |
            ./packages/tdesign-react/dist
            ./packages/tdesign-react/esm
            ./packages/tdesign-react/cjs
            ./packages/tdesign-react/lib
            ./packages/tdesign-react/es
            ./packages/tdesign-react/package.json
          retention-days: 2

  publish:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: download react-18
        uses: dawidd6/action-download-artifact@v6
        with:
          name: react-18
          path: react-18

      - name: download react-19
        uses: dawidd6/action-download-artifact@v6
        with:
          name: react-19
          path: react-19    

      - run: pnpm dlx pkg-pr-new publish './react-18' './react-19' --template ./tdesign-react-demo
